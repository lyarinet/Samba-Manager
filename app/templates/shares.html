{% extends 'layout.html' %}
{% block content %}
<h2>Manage Shares</h2>

{% if not has_sudo %}
<div class="alert alert-warning mb-4">
  <strong>Warning:</strong> Sudo access is required to modify Samba shares.
  Run this application with sudo privileges to enable full functionality.
</div>
{% endif %}

<div class="card bg-dark border-secondary mb-4">
  <div class="card-header">Add or Update Share</div>
  <div class="card-body">
    <form method="POST">
      <div class="row g-2">
        <div class="col-md-2">
          <label class="form-label">Share Name</label>
          <input name="name" placeholder="Share Name" class="form-control" required {% if not has_sudo %}disabled{% endif %}>
        </div>
        <div class="col-md-4">
          <label class="form-label">Path</label>
          <input name="path" placeholder="/srv/share" class="form-control" required {% if not has_sudo %}disabled{% endif %}>
        </div>
        <div class="col-md-3">
          <label class="form-label">Valid Users/Groups</label>
          <select name="valid_users" class="form-control" {% if not has_sudo %}disabled{% endif %}>
            <option value="">-- Select user or group --</option>
            {% for user in users %}<option value="{{ user }}">User: {{ user }}</option>{% endfor %}
            {% for group in groups %}<option value="@{{ group }}">Group: {{ group }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">Access</label>
          <select name="readonly" class="form-control" {% if not has_sudo %}disabled{% endif %}>
            <option value="yes">Read Only</option>
            <option value="no" selected>Read/Write</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">VFS Objects</label>
          <select name="vfs" class="form-control" {% if not has_sudo %}disabled{% endif %}>
            <option value="">None</option>
            <option value="shadow_copy2">Shadow Copy</option>
            <option value="audit">Audit</option>
            <option value="acl_xattr">ACL</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary mt-3" {% if not has_sudo %}disabled{% endif %}>Add / Update Share</button>
    </form>
  </div>
</div>

<div class="card bg-dark border-secondary">
  <div class="card-header">Existing Shares</div>
  <div class="card-body">
    {% if shares %}
    <div class="table-responsive">
      <table class="table table-dark table-bordered table-hover">
        <thead class="table-secondary text-dark">
          <tr>
            <th>Name</th>
            <th>Path</th>
            <th>Users</th>
            <th>Access</th>
            <th>VFS</th>
            <th>Source</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for s in shares %}
          <tr>
            <td>{{ s.name }}</td>
            <td>{{ s.path }}</td>
            <td>{{ s['valid users'] if 'valid users' in s else '' }}</td>
            <td>
              {% if 'read only' in s %}
              <span class="badge {% if s['read only']=='yes' %}bg-warning{% else %}bg-success{% endif %}">
                {{ 'Read Only' if s['read only']=='yes' else 'Read/Write' }}
              </span>
              {% elif 'writable' in s %}
              <span class="badge {% if s['writable']=='no' %}bg-warning{% else %}bg-success{% endif %}">
                {{ 'Read Only' if s['writable']=='no' else 'Read/Write' }}
              </span>
              {% else %}
              <span class="badge bg-secondary">Unknown</span>
              {% endif %}
            </td>
            <td>{{ s['vfs objects'] if 'vfs objects' in s else '' }}</td>
            <td>
              {% if s.name in ['secure-share', 'share'] %}
              <span class="badge bg-info">System</span>
              {% else %}
              <span class="badge bg-secondary">Local</span>
              {% endif %}
            </td>
            <td>
              <form method="POST" style="display:inline">
                <input type="hidden" name="name" value="{{ s.name }}">
                <input type="hidden" name="delete" value="1">
                <button class="btn btn-sm btn-danger" {% if not has_sudo or s.name in ['secure-share', 'share'] %}disabled{% endif %} 
                  title="{% if s.name in ['secure-share', 'share'] %}System shares can only be edited in /etc/samba/smb.conf{% endif %}">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info">No shares configured yet.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
